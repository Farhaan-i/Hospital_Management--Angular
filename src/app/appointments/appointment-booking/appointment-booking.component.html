<div class="booking-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Book New Appointment</mat-card-title>
      <mat-card-subtitle>Step {{step}} of {{maxStep}}</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <mat-horizontal-stepper [selectedIndex]="step - 1" #stepper>
        
        <!-- Step 1: Select Patient -->
        <mat-step label="Select Patient">
          <div class="step-content">
            <h3>Choose Patient</h3>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Patient</mat-label>
              <mat-select formControlName="patientId" required>
                <mat-option *ngFor="let patient of patients" [value]="patient.patientId">
                  {{patient.patientName}} - {{patient.patientPhoneNumber}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="bookingForm.get('patientId')?.hasError('required')">
                Please select a patient
              </mat-error>
            </mat-form-field>
            
            <div class="selected-info" *ngIf="getSelectedPatient()">
              <h4>Selected Patient:</h4>
              <p><strong>Name:</strong> {{getSelectedPatient()?.patientName}}</p>
              <p><strong>Email:</strong> {{getSelectedPatient()?.patientEmail}}</p>
              <p><strong>Phone:</strong> {{getSelectedPatient()?.patientPhoneNumber}}</p>
            </div>
          </div>
        </mat-step>

        <!-- Step 2: Select Doctor -->
        <mat-step label="Select Doctor">
          <div class="step-content">
            <h3>Choose Doctor</h3>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Doctor</mat-label>
              <mat-select formControlName="doctorId" (selectionChange)="onDoctorChange()" required>
                <mat-option *ngFor="let doctor of doctors" [value]="doctor.doctorId">
                  Dr. {{doctor.doctorName}} - {{doctor.specialization}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="bookingForm.get('doctorId')?.hasError('required')">
                Please select a doctor
              </mat-error>
            </mat-form-field>
            
            <div class="selected-info" *ngIf="getSelectedDoctor()">
              <h4>Selected Doctor:</h4>
              <p><strong>Name:</strong> Dr. {{getSelectedDoctor()?.doctorName}}</p>
              <p><strong>Specialization:</strong> {{getSelectedDoctor()?.specialization}}</p>
              <p><strong>Contact:</strong> {{getSelectedDoctor()?.doctorContactNumber}}</p>
            </div>
          </div>
        </mat-step>

        <!-- Step 3: Select Date -->
        <mat-step label="Select Date">
          <div class="step-content">
            <h3>Choose Appointment Date</h3>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Appointment Date</mat-label>
              <input matInput 
                     [matDatepicker]="picker" 
                     formControlName="appointmentDate" 
                     (dateChange)="onDateChange()"
                     [min]="minDate"
                     required>
              <mat-hint>Select a future date</mat-hint>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="bookingForm.get('appointmentDate')?.hasError('required')">
                Please select an appointment date
              </mat-error>
            </mat-form-field>
          </div>
        </mat-step>

        <!-- Step 4: Select Time Slot -->
        <mat-step label="Select Time Slot">
          <div class="step-content">
            <h3>Choose Available Time Slot</h3>
            
            <div *ngIf="loading" class="loading-spinner">
              <mat-spinner></mat-spinner>
              <p>Loading available slots...</p>
            </div>
            
            <div *ngIf="availableSlots.length === 0 && !loading" class="no-slots">
              <mat-icon>schedule</mat-icon>
              <p>No available slots for the selected date. Please choose a different date.</p>
            </div>
            
            <div *ngIf="availableSlots.length > 0 && !loading" class="slots-grid">
              <mat-radio-group formControlName="slotId">
                <mat-radio-button 
                  *ngFor="let slot of availableSlots" 
                  [value]="slot.slotId"
                  class="slot-radio">
                  {{slot.startTime}} - {{slot.endTime}}
                </mat-radio-button>
              </mat-radio-group>
            </div>
          </div>
        </mat-step>

      </mat-horizontal-stepper>
    </mat-card-content>

    <mat-card-actions>
      <div class="action-buttons">
        <button mat-button
                (click)="prevStep()"
                [disabled]="step === 1">
          Previous
        </button>
        
        <button mat-raised-button
                color="primary"
                (click)="nextStep()"
                *ngIf="step < maxStep"
                [disabled]="!isStepValid()">
          {{step === 3 ? 'View Available Slots' : 'Next'}}
        </button>
        
        <button mat-raised-button
                color="primary"
                (click)="bookAppointment()"
                *ngIf="step === maxStep"
                [disabled]="!bookingForm.valid || loading">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          Confirm Appointment
        </button>
      </div>
    </mat-card-actions>
  </mat-card>
</div>